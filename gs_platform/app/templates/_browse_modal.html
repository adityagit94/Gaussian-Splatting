<!-- ~/gs_platform/app/templates/_browse_modal.html  (FULL UPDATED FILE - JS set value) -->
<div id="modal-backdrop"
  style="position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; z-index:9999;">
  <div style="background:#fff; width:min(1000px, 94vw); max-height:84vh; overflow:auto; border-radius:14px; border:1px solid #ddd; padding:14px;">

    <script>
        function gsSetField(target, value) {
            const el = document.querySelector(`input[name="${target}"]`);
            if (!el) { alert(`Missing input[name="${target}"]`); return; }

            // ‚úÖ enforce XOR between video and images_dir
            if (target === "video") {
            const img = document.querySelector(`input[name="images_dir"]`);
            if (img) img.value = "";
            }
            if (target === "images_dir") {
            const vid = document.querySelector(`input[name="video"]`);
            if (vid) vid.value = "";
            }

            el.value = value;
            document.getElementById('modal').innerHTML = '';
        }
    </script>

    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div>
        <div style="font-weight:700;">Browse ({{mode}}){% if video_only %} ‚Äî videos only{% endif %}</div>
        <div style="color:#666; font-size:12px;">{{cur}}</div>
      </div>
      <button class="btn" type="button" onclick="document.getElementById('modal').innerHTML=''">Close</button>
    </div>

    <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
      <button class="btn" type="button"
        hx-get="/browse?target={{target}}&mode={{mode}}&path={{parent|urlq}}&q={{q|urlq}}"
        hx-target="#modal" hx-swap="innerHTML">‚¨Ü Parent</button>

      <!-- ‚úÖ No HTMX request needed: just set value -->
      <button class="btn" type="button"
        onclick="gsSetField('{{target}}', '{{cur}}')">
        Select this folder
      </button>
    </div>

    <!-- Search -->
    <div style="margin-top:10px;">
      <form
        hx-get="/browse"
        hx-target="#modal"
        hx-swap="innerHTML"
        style="display:flex; gap:10px; align-items:center;">
        <input type="hidden" name="target" value="{{target}}">
        <input type="hidden" name="mode" value="{{mode}}">
        <input type="hidden" name="path" value="{{cur}}">
        <input name="q" value="{{q}}" placeholder="Search in this folder (e.g. mp4, A001, auditorium)"
               style="flex:1; padding:8px; border:1px solid #ccc; border-radius:10px;">
        <button class="btn" type="submit">Search</button>
        <button class="btn" type="button"
          hx-get="/browse?target={{target}}&mode={{mode}}&path={{cur|urlq}}&q="
          hx-target="#modal" hx-swap="innerHTML">Clear</button>
      </form>

      {% if video_only %}
        <div style="color:#666; font-size:12px; margin-top:6px;">
          Showing only: {{video_exts}}
        </div>
      {% endif %}
    </div>

    <!-- New folder -->
    <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
      <form
        hx-post="/browse/mkdir"
        hx-target="#modal"
        hx-swap="innerHTML"
        style="display:flex; gap:10px; align-items:center; width:100%;">
        <input type="hidden" name="target" value="{{target}}">
        <input type="hidden" name="mode" value="{{mode}}">
        <input type="hidden" name="cur" value="{{cur}}">
        <input type="hidden" name="q" value="{{q}}">
        <input name="name" placeholder="New folder name"
               style="flex:1; padding:8px; border:1px solid #ccc; border-radius:10px;">
        <button class="btn" type="submit">Create folder</button>
      </form>
    </div>

    {% if error %}
      <div style="color:#b00020; margin-top:10px; font-size:12px;">
        Error: {{error}}
      </div>
    {% endif %}

    <hr style="margin:12px 0; border:none; border-top:1px solid #eee;" />

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
      <div>
        <div style="font-weight:700; margin-bottom:8px;">Folders</div>

        {% if dirs|length == 0 %}
          <div style="color:#666; font-size:12px;">No folders found.</div>
        {% endif %}

        {% for d in dirs %}
          <div style="margin-bottom:6px;">
            <button class="btn" type="button" style="width:100%; text-align:left;"
              hx-get="/browse?target={{target}}&mode={{mode}}&path={{(cur ~ '/' ~ d)|urlq}}&q={{q|urlq}}"
              hx-target="#modal" hx-swap="innerHTML">
              üìÅ {{d}}
            </button>
          </div>
        {% endfor %}
      </div>

      {% if mode == "file" %}
      <div>
        <div style="font-weight:700; margin-bottom:8px;">Files</div>

        {% if files|length == 0 %}
          <div style="color:#666; font-size:12px;">No matching files.</div>
        {% endif %}

        {% for f in files %}
          <div style="margin-bottom:6px;">
            <!-- ‚úÖ No HTMX request needed: just set value -->
            <button class="btn" type="button" style="width:100%; text-align:left;"
              onclick="gsSetField('{{target}}', '{{cur ~ '/' ~ f}}')">
              üìÑ {{f}}
            </button>
          </div>
        {% endfor %}

        <div style="color:#666; font-size:12px; margin-top:6px;">Showing up to 500 files.</div>
      </div>
      {% endif %}
    </div>

  </div>
</div>